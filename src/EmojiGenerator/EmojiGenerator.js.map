{"version":3,"file":"EmojiGenerator.js","sourceRoot":"","sources":["EmojiGenerator.ts"],"names":[],"mappings":"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","sourcesContent":["import {FrameGenerator, LinearGenerator, RotationGenerator, RotationGeneratorFlex} from \"./FrameGenerator.js\"\r\nimport {AnimatedImage, Frame, FrameType, ImageUpdateFrame, Pixels} from \"../Image/AnimatedImage.js\"\r\nimport {Options} from \"../Application.js\"\r\nimport {RelativeImage} from \"../Image/RelativeImage/RelativeImage.js\"\r\nimport {Utils} from \"../Utils/Utils.js\"\r\nimport {RelativeFabricImage} from \"../Image/RelativeImage/RelativeFabricImage.js\"\r\nimport {FabricCanvas} from \"../FabricWrapper/FabricCanvas.js\"\r\n\r\nexport class EmojiGenerator {\r\n  constructor(\r\n    public namePrefix: string,\r\n    public frameGenerator: FrameGenerator,\r\n    public rotation: number = 0,\r\n    public flipX: Boolean = false\r\n  ) {\r\n  }\r\n\r\n  private static prepareCanvas(canvas: FabricCanvas) {\r\n    canvas.clear()\r\n    canvas.setBackgroundColor(\"#FFFFFF\", null)\r\n  }\r\n\r\n  async generate(image: AnimatedImage, options: Options): Promise<AnimatedImage> {\r\n    let timeline: Array<Frame> = []\r\n    const relativeImage = new RelativeImage(image)\r\n\r\n    relativeImage.rescaleToFit(options.width, options.height)\r\n\r\n    let currentImage: RelativeFabricImage\r\n    let lastFrameTime: number\r\n    for (const frame of image.timeline) {\r\n      const index = image.timeline.indexOf(frame)\r\n      if (frame.type !== FrameType.End) {\r\n        const canvas = Utils.createCanvas(options.width, options.height)\r\n        relativeImage.attach(canvas)\r\n        const timeNormalized = index / (image.timeline.length - 1)\r\n\r\n        if (this.flipX) {\r\n\r\n//FIXME flipx functionality\r\n        }\r\n\r\n        if (frame.type == FrameType.ImageUpdate) {\r\n          currentImage = await relativeImage.getFabricImageForFrame(frame as ImageUpdateFrame)\r\n        }\r\n\r\n        EmojiGenerator.prepareCanvas(canvas)\r\n\r\n        const relativeFabricImages = await this.frameGenerator(currentImage, timeNormalized)\r\n        relativeFabricImages.forEach(img => canvas.add(img.underlying))\r\n\r\n        canvas.renderAll()\r\n\r\n        const imageData = canvas.contextContainer.getImageData(0, 0, options.width, options.height)\r\n\r\n        EmojiGenerator.prepareCanvas(canvas)\r\n\r\n        const imageForRotation = await Utils.fabricImageFromDataUrl(Utils.imageDataToDataUrl(imageData))\r\n        imageForRotation.set({\r\n          originX: \"center\",\r\n          originY: \"center\",\r\n          angle: this.rotation,\r\n          left: canvas.width / 2,\r\n          top: canvas.height / 2,\r\n        })\r\n        canvas.add(imageForRotation)\r\n        canvas.renderAll()\r\n\r\n        timeline.push(new ImageUpdateFrame(Pixels.fromImageData(canvas.contextContainer.getImageData(0, 0, options.width, options.height)), frame.time))\r\n        lastFrameTime = frame.time\r\n      } else\r\n        timeline.push(frame)\r\n    }\r\n\r\n\r\n    return new AnimatedImage(options.width, options.height, timeline)\r\n  }\r\n\r\n  static allGenerators: Map<string, EmojiGenerator> = new Map([\r\n    new EmojiGenerator(\"lr\", LinearGenerator),\r\n    new EmojiGenerator(\"ud\", LinearGenerator, 90),\r\n    new EmojiGenerator(\"rl\", LinearGenerator, 180),\r\n    new EmojiGenerator(\"du\", LinearGenerator, 270),\r\n    new EmojiGenerator(\"ld\", RotationGeneratorFlex),\r\n    new EmojiGenerator(\"ul\", RotationGeneratorFlex, 90),\r\n    new EmojiGenerator(\"ru\", RotationGeneratorFlex, 180),\r\n    new EmojiGenerator(\"dr\", RotationGeneratorFlex, 270),\r\n  ].map(renderer => [renderer.namePrefix, renderer]))\r\n}\r\n\r\n"]}