{"version":3,"file":"Application.js","sourceRoot":"","sources":["Application.ts"],"names":[],"mappings":"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","sourcesContent":["import {Emoji} from \"./Image/Emoji.js\"\r\nimport {DataUrl, Seconds} from \"./Domain.js\"\r\nimport {AnimatedImage} from \"./Image/AnimatedImage.js\"\r\nimport {Option} from \"./Utils/Option.js\"\r\nimport {Utils} from \"./Utils/Utils.js\"\r\nimport {EmojiGenerator} from \"./EmojiGenerator/EmojiGenerator.js\"\r\n\r\n\r\nexport interface ImageOptions {\r\n  image: AnimatedImage,\r\n  name: string\r\n}\r\n\r\nexport interface ExpandTimelineOptions {\r\n  length: Seconds,\r\n  fps: number\r\n}\r\n\r\nexport interface Options {\r\n  sourceImage: Option<ImageOptions>\r\n  width: number\r\n  height: number\r\n  expandTimeline: Option<ExpandTimelineOptions>\r\n}\r\n\r\n\r\nexport class Application {\r\n  emojies: Emoji[] = []\r\n  options: Options = {\r\n    width: 64,\r\n    height: 64,\r\n    sourceImage: Option.none(),\r\n    expandTimeline: Option.none()\r\n  }\r\n\r\n  constructor(\r\n    private fileInput: HTMLInputElement,\r\n    private redrawButton: HTMLButtonElement,\r\n    private smileSizeInput: HTMLInputElement,\r\n    private compressionInput: HTMLInputElement,\r\n    private forceAnimateInput: HTMLInputElement,\r\n    private animationLengthInput: HTMLInputElement,\r\n    private fpsInput: HTMLInputElement,\r\n    private imagePreview: HTMLImageElement,\r\n    private downloadButton: HTMLButtonElement,\r\n    private syncGifsButton: HTMLButtonElement\r\n  ) {\r\n    this.reloadOptions()\r\n  }\r\n\r\n  initializeEvents() {\r\n    this.redrawButton.onclick = () => this.redraw()\r\n    this.smileSizeInput.onchange = () => this.reloadOptions()\r\n    this.compressionInput.onchange = () => this.reloadOptions()\r\n    this.animationLengthInput.onchange = () => this.reloadOptions()\r\n    this.fpsInput.onchange = () => this.reloadOptions()\r\n    this.forceAnimateInput.onchange = () => {\r\n      if (this.forceAnimateInput.checked) {\r\n        this.animationLengthInput.disabled = false\r\n        this.fpsInput.disabled = false\r\n      } else {\r\n        this.animationLengthInput.disabled = true\r\n        this.fpsInput.disabled = true\r\n      }\r\n\r\n      this.reloadOptions()\r\n    }\r\n    this.fileInput.onchange = (event: any) => {\r\n      this.imagePreview.src = \"resources/loading.gif\"\r\n      const fileList = event.target.files\r\n      const file: File = fileList.item(0)\r\n      const reader = new FileReader()\r\n      reader.onloadend = () => this.onFileSelection(file, reader.result as ArrayBuffer)\r\n      setTimeout(() => reader.readAsArrayBuffer(file), 10)\r\n    }\r\n\r\n    this.emojies = Array.from(document.getElementsByClassName(\"Emoji\")).map(\r\n      element => {\r\n        const rendererType = element.getAttribute(\"renderer\")\r\n        const renderer = EmojiGenerator.allGenerators.get(rendererType)\r\n        const emoji = new Emoji(renderer)\r\n        emoji.attach(element as HTMLImageElement)\r\n        return emoji\r\n      }\r\n    )\r\n\r\n    this.downloadButton.onclick = () => this.downloadRenderedEmojies()\r\n    this.syncGifsButton.onclick = () => {\r\n      // noinspection SillyAssignmentJS\r\n      this.emojies.forEach(emoji => emoji.imageElement.forEach(imgElement => imgElement.src = imgElement.src))\r\n    }\r\n  }\r\n\r\n  reloadOptions() {\r\n    const oldOptions = this.options\r\n    const size = Number(this.smileSizeInput.value)\r\n    let expandTimelineOptions = Option.none<ExpandTimelineOptions>()\r\n    if (this.forceAnimateInput.checked)\r\n      expandTimelineOptions = Option.some(\r\n        {\r\n          length: Number(this.animationLengthInput.value),\r\n          fps: Number(this.fpsInput.value)\r\n        }\r\n      )\r\n    this.options = {\r\n      sourceImage: oldOptions.sourceImage,\r\n      width: size,\r\n      height: size,\r\n      expandTimeline: expandTimelineOptions\r\n    }\r\n  }\r\n\r\n  redraw() {\r\n    this.options.sourceImage.forEach(imageOptions =>\r\n      this.emojies.forEach(emoji => {\r\n        emoji.imageElement.map(element => element.src = \"resources/loading.gif\")\r\n        // noinspection JSIgnoredPromiseFromCall\r\n        emoji.render(this.options)\r\n      }))\r\n\r\n  }\r\n\r\n  onFileSelection(file: File, data: ArrayBuffer) {\r\n    const fileName = file.name.split(\".\")\r\n    const fileExtension = fileName.pop()\r\n\r\n    AnimatedImage.fromImage(data, fileExtension).then(image => {\r\n      this.imagePreview.src = Utils.arrayBufferToUrl(data, fileExtension)\r\n      this.options.sourceImage = Option.some({\r\n        name: fileName[0],\r\n        image: image.right\r\n      })\r\n      this.redraw()\r\n    })\r\n  }\r\n\r\n  generateEmojiTable(map: (string | null)[][]): HTMLTableElement {\r\n    const table = document.createElement(\"table\")\r\n    table.className = \"emojiTable\"\r\n    const emojies: Emoji[] = []\r\n    map.forEach(row => {\r\n      const rowElement = document.createElement(\"tr\")\r\n      row.forEach(emojiRendererName => {\r\n        const emojiElement = document.createElement(\"img\")\r\n        emojiElement.src = \"resources/transparent.png\"\r\n        emojiElement.className = \"emoji\"\r\n        if (emojiRendererName == null) {\r\n        } else {\r\n          const newEmoji = new Emoji(EmojiGenerator.allGenerators.get(emojiRendererName))\r\n          emojiElement.setAttribute(\"renderer\", emojiRendererName)\r\n          newEmoji.attach(emojiElement)\r\n          emojies.push(newEmoji)\r\n        }\r\n        rowElement.append(emojiElement)\r\n      })\r\n      table.append(rowElement)\r\n    })\r\n\r\n    this.emojies = emojies\r\n    return table\r\n  }\r\n\r\n  downloadBlobAsFile(blob: Blob, filename: string) {\r\n    const fakeMouseEvent = document.createEvent('MouseEvents')\r\n    const fakeElement = document.createElement('a')\r\n\r\n    fakeElement.download = filename\r\n    fakeElement.href = window.URL.createObjectURL(blob)\r\n    fakeElement.dataset.downloadurl = [blob.type, fakeElement.download, fakeElement.href].join(':')\r\n    fakeMouseEvent.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)\r\n    fakeElement.dispatchEvent(fakeMouseEvent)\r\n  }\r\n\r\n  downloadRenderedEmojies() {\r\n    this.emojies.forEach(emoji =>\r\n      emoji.renderedGif.forEach(gifBlob =>\r\n        emoji.renderedName.forEach(name =>\r\n          this.downloadBlobAsFile(gifBlob, name)\r\n        )\r\n      )\r\n    )\r\n  }\r\n}"]}